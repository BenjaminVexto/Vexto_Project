name: Share Vexto debug to Secret Gist

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "src/vexto/scoring/**"
      - "fetcher_diagnose_full.py"
      - "config/scoring_rules.yml"
      - "tests/test_fetcher_matrix.py"
      - "tests/debug_csv.py"
      - "debug_*.html"
      - "final_view*.html"

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Copy whitelisted files
        run: |
          mkdir -p share
          cp -f src/vexto/scoring/http_client.py share/ || true
          cp -f src/vexto/scoring/website_fetchers.py share/ || true
          cp -f src/vexto/scoring/analyzer.py share/ || true
          cp -f src/vexto/scoring/_playwright_thread_fetcher.py share/ || true
          cp -f fetcher_diagnose_full.py share/ || true
          cp -f config/scoring_rules.yml share/ || true
          cp -f tests/test_fetcher_matrix.py share/ || true
          cp -f tests/debug_csv.py share/ || true
          ls -1t debug_*.html 2>/dev/null | head -n 3 | xargs -I{} cp -f {} share/ 2>/dev/null || true
          ls -1t final_view*.html 2>/dev/null | head -n 3 | xargs -I{} cp -f {} share/ 2>/dev/null || true

      # Dropper "Authenticate GH CLI" — gh bruger GH_TOKEN automatisk

      - name: Update Secret Gist (one file at a time)
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}   # gh læser denne automatisk
          GIST_ID: ${{ secrets.GIST_ID }}
        run: |
          gh --version
          shopt -s nullglob
          for f in share/*; do
            echo "Uploading $f"
            gh gist edit "$GIST_ID" "$f"
          done
          echo "Done."
